<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Starting Azure Service Fabric ☁️ | PS Notes</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicon.png">
    <meta name="description" content="Find all my notes here">
    <link rel="preload" href="/blog/assets/css/0.styles.165084a3.css" as="style"><link rel="preload" href="/blog/assets/js/app.5359efb0.js" as="script"><link rel="preload" href="/blog/assets/js/2.ed81277b.js" as="script"><link rel="preload" href="/blog/assets/js/6.ce0118c8.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.798258e1.js"><link rel="prefetch" href="/blog/assets/js/11.c40a9d89.js"><link rel="prefetch" href="/blog/assets/js/12.2bf01719.js"><link rel="prefetch" href="/blog/assets/js/13.3ded62bf.js"><link rel="prefetch" href="/blog/assets/js/14.96e88526.js"><link rel="prefetch" href="/blog/assets/js/15.02dfcd09.js"><link rel="prefetch" href="/blog/assets/js/16.d594b883.js"><link rel="prefetch" href="/blog/assets/js/17.3ca5b683.js"><link rel="prefetch" href="/blog/assets/js/18.d67bb81d.js"><link rel="prefetch" href="/blog/assets/js/19.87d7e7d4.js"><link rel="prefetch" href="/blog/assets/js/20.81bb1bdb.js"><link rel="prefetch" href="/blog/assets/js/21.393b795e.js"><link rel="prefetch" href="/blog/assets/js/22.b4b05b24.js"><link rel="prefetch" href="/blog/assets/js/23.90ebae71.js"><link rel="prefetch" href="/blog/assets/js/24.4d6315c6.js"><link rel="prefetch" href="/blog/assets/js/25.a8ca678d.js"><link rel="prefetch" href="/blog/assets/js/26.20ff403d.js"><link rel="prefetch" href="/blog/assets/js/27.027798ff.js"><link rel="prefetch" href="/blog/assets/js/28.4fcd7904.js"><link rel="prefetch" href="/blog/assets/js/29.ae9953be.js"><link rel="prefetch" href="/blog/assets/js/3.4239afa8.js"><link rel="prefetch" href="/blog/assets/js/30.05ce7139.js"><link rel="prefetch" href="/blog/assets/js/31.929ba55a.js"><link rel="prefetch" href="/blog/assets/js/32.39a7eb88.js"><link rel="prefetch" href="/blog/assets/js/33.aea2c7ad.js"><link rel="prefetch" href="/blog/assets/js/34.f19214f0.js"><link rel="prefetch" href="/blog/assets/js/35.f9689f85.js"><link rel="prefetch" href="/blog/assets/js/36.491b563f.js"><link rel="prefetch" href="/blog/assets/js/37.01c41598.js"><link rel="prefetch" href="/blog/assets/js/38.fef1137c.js"><link rel="prefetch" href="/blog/assets/js/39.d9080be3.js"><link rel="prefetch" href="/blog/assets/js/4.5fcdffa2.js"><link rel="prefetch" href="/blog/assets/js/40.139a3e51.js"><link rel="prefetch" href="/blog/assets/js/41.42d3a459.js"><link rel="prefetch" href="/blog/assets/js/42.f4ad466b.js"><link rel="prefetch" href="/blog/assets/js/43.d8279406.js"><link rel="prefetch" href="/blog/assets/js/44.0d320ca0.js"><link rel="prefetch" href="/blog/assets/js/45.a0bd664a.js"><link rel="prefetch" href="/blog/assets/js/46.75a5939e.js"><link rel="prefetch" href="/blog/assets/js/47.62271a73.js"><link rel="prefetch" href="/blog/assets/js/48.6519ed03.js"><link rel="prefetch" href="/blog/assets/js/5.8f43166e.js"><link rel="prefetch" href="/blog/assets/js/7.2b36b85d.js"><link rel="prefetch" href="/blog/assets/js/8.4109f0ce.js"><link rel="prefetch" href="/blog/assets/js/9.c9802138.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.165084a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/blog/" class="router-link-active no-logo home-link"><!----> <span class="site-name">PS Notes</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item ant-menu-item-selected"><a href="/blog/home/" class="router-link-active">
          Home
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/blog/about/">
          About
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Angular</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/home/deploy-angular-app-to-github-io-pages.html" title="Deploy Angular app to github.io pages" class="sidebar-link">Deploy Angular app to github.io pages</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Azure</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/home/azure-resource-graph-explorer.html" title="Write query using Azure Resource Graph Explorer" class="sidebar-link">Write query using Azure Resource Graph Explorer</a></li><li><a href="/blog/home/azure-keyboard-shortcuts.html" title="Azure Keyboard Shortcuts in Azure Portal" class="sidebar-link">Azure Keyboard Shortcuts in Azure Portal</a></li><li><a href="/blog/home/azure-service-fabric.html" title="Introduction to Azure Service Fabric" class="sidebar-link">Introduction to Azure Service Fabric</a></li><li><a href="/blog/home/starting-azure-service-fabric.html" aria-current="page" title="Starting Azure Service Fabric ☁️" class="active sidebar-link">Starting Azure Service Fabric ☁️</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#options-for-building-microservices-in-azure" title="Options for building Microservices in Azure:" class="sidebar-link">Options for building Microservices in Azure:</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#programming-models-provided-by-service-fabric" title="Programming Models provided by Service Fabric" class="sidebar-link">Programming Models provided by Service Fabric</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#installing-service-fabric" title="Installing Service Fabric" class="sidebar-link">Installing Service Fabric</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#creating-service-fabric-services" title="Creating Service Fabric Services" class="sidebar-link">Creating Service Fabric Services</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#service-fabric-state" title="Service Fabric State" class="sidebar-link">Service Fabric State</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#creating-service-application" title="Creating Service Application" class="sidebar-link">Creating Service Application</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#service-lifecycle" title="Service Lifecycle" class="sidebar-link">Service Lifecycle</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#creating-product-catalog-service" title="Creating Product Catalog Service" class="sidebar-link">Creating Product Catalog Service</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#creating-a-web-api" title="Creating a Web API" class="sidebar-link">Creating a Web API</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#communicating-between-two-services" title="Communicating between two services" class="sidebar-link">Communicating between two services</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#end-to-end-flow" title="End to End flow" class="sidebar-link">End to End flow</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#exploring-actor-model-support" title="Exploring Actor Model Support" class="sidebar-link">Exploring Actor Model Support</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#managing-state" title="Managing State" class="sidebar-link">Managing State</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#getting-ready-for-deployment" title="Getting Ready for Deployment" class="sidebar-link">Getting Ready for Deployment</a></li><li class="sidebar-sub-header"><a href="/blog/home/starting-azure-service-fabric.html#test" title="Test" class="sidebar-link">Test</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kusto</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/home/kusto-overview.html" title="Kusto Query Language (KQL)" class="sidebar-link">Kusto Query Language (KQL)</a></li><li><a href="/blog/home/dynamic-365-hcm-kusto.html" title="Troubleshoot using Kusto" class="sidebar-link">Troubleshoot using Kusto</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>C#</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/csharp/csharp-fundamentals.html" title="OOP Fundamentals" class="sidebar-link">OOP Fundamentals</a></li><li><a href="/blog/csharp/csharp-features.html" title="C# features" class="sidebar-link">C# features</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spark</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Microservices</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="starting-azure-service-fabric"><a href="#starting-azure-service-fabric" class="header-anchor">#</a> Starting Azure Service Fabric ☁️</h1> <h2 id="options-for-building-microservices-in-azure"><a href="#options-for-building-microservices-in-azure" class="header-anchor">#</a> Options for building Microservices in Azure:</h2> <ul><li>Azure Kubernetes Service - Container Orchestrator</li> <li>Azure Service Fabric - Microservice framework and orchestrator that solves many of problems
<ul><li>Service Communication</li> <li>Service discovery</li> <li>Telemetry</li> <li>Provision and upgrade</li> <li>Testing locally</li> <li>Manage downtimes</li> <li>Scaling in and out</li></ul></li> <li>Azure Functions</li></ul> <h2 id="programming-models-provided-by-service-fabric"><a href="#programming-models-provided-by-service-fabric" class="header-anchor">#</a> Programming Models provided by Service Fabric</h2> <ul><li>Reliable services
<ul><li>stateless (similar to console app)</li> <li>stateful</li></ul></li> <li>Reliable actors - Virtual actor design pattern built on top of stateful reliable services framework to handle massive amount of client request with enormous computing power</li> <li>Guest executables - Wrap any existing application to run on Service Fabric</li> <li>Containers</li></ul> <h2 id="installing-service-fabric"><a href="#installing-service-fabric" class="header-anchor">#</a> Installing Service Fabric</h2> <p>Service Fabric is best in cloud environment but can be installed in On Premise as well as in Developer workstation and the is no difference the underlying Service Fabric.</p> <p><strong>OneBox</strong> - Azure Service Fabric Cluster that can be deployed to a single dev machine.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Tools:</p> <ul><li>Visual Studio 2019 (Community Version would work as well)</li> <li>Service Fabric tooling (it's a part of Visual studio components)</li> <li>Service Fabric SDK (can be installed as isolated package or use Web Platform Installer)</li></ul></div> <h2 id="creating-service-fabric-services"><a href="#creating-service-fabric-services" class="header-anchor">#</a> Creating Service Fabric Services</h2> <h3 id="service-fabric-state"><a href="#service-fabric-state" class="header-anchor">#</a> <strong>Service Fabric State</strong></h3> <p>The minimum set of replica to achieve data consistency is called quorum. The size is usually 3 nodes. Service state consist of local storage to save persist state therefore is very fast.</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Let's create application with these services
We will create services</p> <ul><li>Web Server (API) - It's a stateless service and only act as a facade.</li> <li>Product Catalog - It's a stateful service.</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Both of these services are reliable services as they runs in the background. Reliable service has access to ASF API which is all about microservies, scaling, health report and many more. It has various communication model as http, ftp, websocket etc. It's all about low latency and high speed. It also has access to reliable storage. All these features comes with simple programming model.</p> <h3 id="creating-service-application"><a href="#creating-service-application" class="header-anchor">#</a> Creating Service Application</h3> <p>When we create a new service</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Diagnostics</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog</span>
<span class="token punctuation">{</span>
    <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// This is the entry point of the service host process.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// The ServiceManifest.XML file defines one or more service type names.</span>
                <span class="token comment">// Registering a service maps a service type name to a .NET type.</span>
                <span class="token comment">// When Service Fabric creates an instance of this service type,</span>
                <span class="token comment">// an instance of the class is created in this host process.</span>

                ServiceRuntime<span class="token punctuation">.</span><span class="token function">RegisterServiceAsync</span><span class="token punctuation">(</span><span class="token string">&quot;ECommerce.ProductCatalogType&quot;</span><span class="token punctuation">,</span>
                    context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProductCatalog</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                ServiceEventSource<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">ServiceTypeRegistered</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ProductCatalog</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Prevents this host process from terminating so services keep running.</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>Timeout<span class="token punctuation">.</span>Infinite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ServiceEventSource<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">ServiceHostInitializationFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>Let's checkout what happens in the code</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>There is another class get create which ASF creates the instance during run time and this is the entry point for the service.
<strong>ProductCatalog.cs</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Fabric</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Communication<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ProductCatalog</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">StatefulService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">ProductCatalog</span><span class="token punctuation">(</span><span class="token class-name">StatefulServiceContext</span> context<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;remarks&gt;</span>
        <span class="token comment">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
        <span class="token comment">/// &lt;/remarks&gt;</span>
        <span class="token comment">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceReplicaListener<span class="token punctuation">&gt;</span></span> <span class="token function">CreateServiceReplicaListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceReplicaListener</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// This is the main entry point for your service replica.</span>
        <span class="token comment">/// This method executes when this replica of your service becomes primary and has write status.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name=&quot;cancellationToken&quot;&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// TODO: Replace the following sample code with your own logic </span>
            <span class="token comment">//       or remove this RunAsync override if it's not needed in your service.</span>

            <span class="token class-name"><span class="token keyword">var</span></span> myDictionary <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>StateManager<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetOrAddAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IReliableDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;myDictionary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                cancellationToken<span class="token punctuation">.</span><span class="token function">ThrowIfCancellationRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> tx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>StateManager<span class="token punctuation">.</span><span class="token function">CreateTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> myDictionary<span class="token punctuation">.</span><span class="token function">TryGetValueAsync</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token string">&quot;Counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    ServiceEventSource<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">ServiceMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token string">&quot;Current Counter Value: {0}&quot;</span><span class="token punctuation">,</span>
                        <span class="token return-type class-name">result<span class="token punctuation">.</span>HasValue <span class="token punctuation">?</span></span> result<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">&quot;Value does not exist.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">await</span> myDictionary<span class="token punctuation">.</span><span class="token function">AddOrUpdateAsync</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token string">&quot;Counter&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">++</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// If an exception is thrown before calling CommitAsync, the transaction aborts, all changes are </span>
                    <span class="token comment">// discarded, and nothing is saved to the secondary replicas.</span>
                    <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">CommitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h3 id="service-lifecycle"><a href="#service-lifecycle" class="header-anchor">#</a> Service Lifecycle</h3> <p><strong>Startup</strong></p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p><strong>Shutdown</strong></p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>It's very important to <strong>always respond to cancellationToken event as soon as possible</strong> if we run RunAsync all the time in the background</p></div> <h3 id="creating-product-catalog-service"><a href="#creating-product-catalog-service" class="header-anchor">#</a> Creating Product Catalog Service</h3> <p><strong>Product Entity</strong></p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Now lets add IProuductRepostory and Product in library project and reference it from ProductCatalog Service project.
<strong>IProductRepository</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IProductRepository</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token return-type class-name">Task</span> <span class="token function">AddProudct</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>Product</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Description <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> Price <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Availability <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Let's create ServiceFabricProductRepository nad update ProductCatalog in ProductCatalog project.
<strong>ServiceFabricProductRepository</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Data</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">ServcieFabricProductRepostiory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProductRepository</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IReliableStateManager</span> _stateManager<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">ServcieFabricProductRepostiory</span><span class="token punctuation">(</span><span class="token class-name">IReliableStateManager</span> stateManager<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _stateManager <span class="token operator">=</span> stateManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AddProudct</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> products <span class="token operator">=</span> <span class="token keyword">await</span> _stateManager<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetOrAddAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IReliableDictionary<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">,</span> Product<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">ITransaction</span> tx <span class="token operator">=</span> _stateManager<span class="token punctuation">.</span><span class="token function">CreateTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> products<span class="token punctuation">.</span><span class="token function">AddOrUpdateAsync</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> product<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> product<span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">CommitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> products <span class="token operator">=</span> <span class="token keyword">await</span> _stateManager<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetOrAddAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IReliableDictionary<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">,</span> Product<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">ITransaction</span> tx <span class="token operator">=</span> _stateManager<span class="token punctuation">.</span><span class="token function">CreateTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> allProducts <span class="token operator">=</span> <span class="token keyword">await</span> products<span class="token punctuation">.</span><span class="token function">CreateEnumerableAsync</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> EnumerationMode<span class="token punctuation">.</span>Unordered<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> enumerator <span class="token operator">=</span> allProducts<span class="token punctuation">.</span><span class="token function">GetAsyncEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">await</span> enumerator<span class="token punctuation">.</span><span class="token function">MoveNextAsync</span><span class="token punctuation">(</span>CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        result<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>enumerator<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><strong>ProductCatalog</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Fabric</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Communication<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ProductCatalog</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">StatefulService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ServcieFabricProductRepostiory</span> _repo<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">ProductCatalog</span><span class="token punctuation">(</span><span class="token class-name">StatefulServiceContext</span> context<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;remarks&gt;</span>
        <span class="token comment">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
        <span class="token comment">/// &lt;/remarks&gt;</span>
        <span class="token comment">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceReplicaListener<span class="token punctuation">&gt;</span></span> <span class="token function">CreateServiceReplicaListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceReplicaListener</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// This is the main entry point for your service replica.</span>
        <span class="token comment">/// This method executes when this replica of your service becomes primary and has write status.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name=&quot;cancellationToken&quot;&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> product1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Dell Monitor&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Monitor&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">100</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> product2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Keyboard&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Accesories&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">510</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">110</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> product3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Mouse&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Accesories&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">520</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">120</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            _repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServcieFabricProductRepostiory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>StateManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProudct</span><span class="token punctuation">(</span>product1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProudct</span><span class="token punctuation">(</span>product2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProudct</span><span class="token punctuation">(</span>product3<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> all <span class="token operator">=</span> <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>At this point we should be able to run the application and check there are 3 products in all variable which is await of GetProducts()</p> <p>This is how the solution should look like:
<img src="/blog/assets/img/ECommerce_Sln.573c4e11.png" alt="ECommerce Solution"></p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Visual Studio need to run in elevated mode as Admin to allow access network level resources</p></div> <h3 id="creating-a-web-api"><a href="#creating-a-web-api" class="header-anchor">#</a> Creating a Web API</h3> <p>To add new Stateless ASP .net Core Web API, right click on ECommerce project and add New Service Fabric Service and choose, stateless asp.net core API.
<img src="/blog/assets/img/SF_Create_WebAPI.4d7f7f98.png" alt="New API"></p> <p>Program.cs is console application very similar to previous one which resisters the service type.</p> <p>API</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Fabric</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Hosting</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Communication<span class="token punctuation">.</span>AspNetCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Communication<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>API</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// The FabricRuntime creates an instance of this class for each service type instance. </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">API</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">StatelessService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">API</span><span class="token punctuation">(</span><span class="token class-name">StatelessServiceContext</span> context<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Optional override to create listeners (like tcp, http) for this service instance.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;The collection of listeners.&lt;/returns&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceInstanceListener<span class="token punctuation">&gt;</span></span> <span class="token function">CreateServiceInstanceListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceInstanceListener<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceInstanceListener</span><span class="token punctuation">(</span>serviceContext <span class="token operator">=&gt;</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KestrelCommunicationListener</span><span class="token punctuation">(</span>serviceContext<span class="token punctuation">,</span> <span class="token string">&quot;ServiceEndpoint&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        ServiceEventSource<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">ServiceMessage</span><span class="token punctuation">(</span>serviceContext<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Starting Kestrel on </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">url</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebHostBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>
                                        services <span class="token operator">=&gt;</span> services
                                            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>StatelessServiceContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>serviceContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">UseContentRoot</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Startup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">UseServiceFabricIntegration</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> ServiceFabricIntegrationOptions<span class="token punctuation">.</span>None<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">UseUrls</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><strong>KestrelCommunicationListener</strong> is standard fabric listener which bootstrap asp.net core runtime and configure it to run inside service fabric environment.</p> <p>Let's add Product Api Model</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiProduct</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Description <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> Price <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;isAvailable&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> IsAvailable <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Here is new project structure:
<img src="/blog/assets/img/ECommerce1_Sln.d309644f.png" alt="Solution"></p> <h3 id="communicating-between-two-services"><a href="#communicating-between-two-services" class="header-anchor">#</a> Communicating between two services</h3> <p>Let's say there are 3 nodes in a cluster</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Since API are stateless they are active in all nodes but Catalog Service is stateful so Service Fabric makes one active and other two passive in case of fail over.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Never assume a service is running in a fixed location. Services in Service Fabric can move around and change roles all the time during the lifetime of the application and even between requests. Therefore, before making the request we should always query the service location from Service Fabric runtime.</p></div> <p>Service Fabric is protocol agnostic. Out of the box there are three protocols:</p> <ul><li>WCF</li> <li>HTTP</li> <li>Service Remoting (Default protocol for reliable communication)</li></ul> <p>Benefits of using Service Remoting:</p> <ul><li>Automatic service address resolution</li> <li>Establishing connection</li> <li>Retries</li> <li>Error handling</li> <li>Strong typed</li> <li>Fast</li></ul> <p>For the purpose of remoting we are adding Service interface in the Model
<strong>IProductCatalogService</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Remoting</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IProductCatalogService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IService</span></span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Product<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetALlProductsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token return-type class-name">Task</span> <span class="token function">AddProductAsync</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>We need to install the remoting service library.
<img src="/blog/assets/img/SF_Add_Remoting_Service_lib.1c9754f2.png" alt="Remoting service library"></p> <p>And implement IProductCatalogService in ProductCatalog</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Fabric</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Communication<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>V2<span class="token punctuation">.</span>FabricTransport<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ProductCatalog</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">StatefulService</span><span class="token punctuation">,</span> <span class="token class-name">IProductCatalogService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ServiceFabricProductRepository</span> _repo<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">ProductCatalog</span><span class="token punctuation">(</span><span class="token class-name">StatefulServiceContext</span> context<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AddProductAsync</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Product<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetALlProductsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;remarks&gt;</span>
        <span class="token comment">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
        <span class="token comment">/// &lt;/remarks&gt;</span>
        <span class="token comment">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceReplicaListener<span class="token punctuation">&gt;</span></span> <span class="token function">CreateServiceReplicaListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceReplicaListener</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FabricTransportServiceRemotingListener</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// This is the main entry point for your service replica.</span>
        <span class="token comment">/// This method executes when this replica of your service becomes primary and has write status.</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name=&quot;cancellationToken&quot;&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> product1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Dell Monitor&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Monitor&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">100</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> product2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Keyboard&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Accessories&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">510</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">110</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> product3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">&quot;Mouse&quot;</span><span class="token punctuation">,</span>
                Description <span class="token operator">=</span> <span class="token string">&quot; Computer Accessories&quot;</span><span class="token punctuation">,</span>
                Price <span class="token operator">=</span> <span class="token number">520</span><span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">120</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            _repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceFabricProductRepository</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>StateManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProduct</span><span class="token punctuation">(</span>product1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProduct</span><span class="token punctuation">(</span>product2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">AddProduct</span><span class="token punctuation">(</span>product3<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> all <span class="token operator">=</span> <span class="token keyword">await</span> _repo<span class="token punctuation">.</span><span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The return type must be array as the service remoting doesn't understand IEnumerable and it needs to transform over the networks it should be simple type.</p></div> <p>Finally it's time to add proxy in API to connect to ProductCatalogService.
<strong>ProductController</strong></p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>ProductCatalog<span class="token punctuation">.</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>ServiceFabric<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>V2<span class="token punctuation">.</span>FabricTransport<span class="token punctuation">.</span>Client</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ECommerce<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductsController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IProductCatalogService</span> _service<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">ProductsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceProxyFactory</span><span class="token punctuation">(</span>
                c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FabricTransportServiceRemotingClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            _service <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateServiceProxy</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IProductCatalogService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;fabric:/ECommerce/ECommerce.ProductCatalog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServicePartitionKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>ApiProduct<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> allProducts <span class="token operator">=</span> <span class="token keyword">await</span> _service<span class="token punctuation">.</span><span class="token function">GetAllProductsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> allProducts<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ApiProduct</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> p<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                Name <span class="token operator">=</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                Description <span class="token operator">=</span> p<span class="token punctuation">.</span>Description<span class="token punctuation">,</span>
                Price <span class="token operator">=</span> p<span class="token punctuation">.</span>Price<span class="token punctuation">,</span>
                IsAvailable <span class="token operator">=</span> p<span class="token punctuation">.</span>Availability <span class="token operator">&gt;</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">PostAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">ApiProduct</span> product<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> newProduct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> product<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                Description <span class="token operator">=</span> product<span class="token punctuation">.</span>Description<span class="token punctuation">,</span>
                Price <span class="token operator">=</span> product<span class="token punctuation">.</span>Price<span class="token punctuation">,</span>
                Availability <span class="token operator">=</span> <span class="token number">100</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> _service<span class="token punctuation">.</span><span class="token function">AddProductAsync</span><span class="token punctuation">(</span>newProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>      
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>Launch the application and test it with Postman for both get and post.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>URI Format for proxy:
fabric/ApplicationName/ServiceName
Eg: fabric:/ECommerce/ProductCatalog</p></div> <h3 id="end-to-end-flow"><a href="#end-to-end-flow" class="header-anchor">#</a> <strong>End to End flow</strong></h3> <p>Here is end to end flow:<br>
API: Stateless service<br>
ProductsController (Product_API)<br>
ProductCatalog: StatefulService, IProductCatalogService</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h2 id="exploring-actor-model-support"><a href="#exploring-actor-model-support" class="header-anchor">#</a> Exploring Actor Model Support</h2> <h2 id="managing-state"><a href="#managing-state" class="header-anchor">#</a> Managing State</h2> <h2 id="getting-ready-for-deployment"><a href="#getting-ready-for-deployment" class="header-anchor">#</a> Getting Ready for Deployment</h2> <h2 id="test"><a href="#test" class="header-anchor">#</a> Test</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/home/azure-service-fabric.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        Introduction to Azure Service Fabric
      </a></span> <span class="next"><a href="/blog/home/kusto-overview.html">
        Kusto Query Language (KQL)
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5359efb0.js" defer></script><script src="/blog/assets/js/2.ed81277b.js" defer></script><script src="/blog/assets/js/6.ce0118c8.js" defer></script>
  </body>
</html>